<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Pantry Scan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #dbf6fa; }
        .dark ::-webkit-scrollbar-track { background: #273f43; }
        ::-webkit-scrollbar-thumb { background: #00424a; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #bac6ea; }
        .dark ::-webkit-scrollbar-thumb { background: #bac6ea; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 300ms, transform 300ms; }
        .modal-leave-active { opacity: 0; transform: scale(0.95); transition: opacity 300ms, transform 300ms; }
        .custom-focus-ring:focus { outline: none; box-shadow: 0 0 0 3px rgba(47, 59, 88, 0.5); }
        .dark .custom-focus-ring:focus { box-shadow: 0 0 0 3px rgba(186, 198, 234, 0.6); }
        #video, #canvas { max-width: 100%; border-radius: 0.5rem; }

        @media (max-width: 768px) {
            .hidden-sm { display: none; }
            th, td {
                padding: 0.5rem;
            }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#00424a', 'primary-light': '#edfcff',
                        'secondary-dark': '#273f43', 'secondary-light': '#dbf6fa',
                        'tertiary-dark': '#2f3b58', 'tertiary-light': '#bac6ea',
                        'app-bg': '#cde7ec', 'error': '#de3730',
                        'neutral-dark': '#393c3d', 'neutral-light': '#f8fafa',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], },
                },
            },
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-app-bg dark:bg-secondary-dark font-sans text-neutral-dark dark:text-neutral-light transition-colors duration-300">

    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-2xl sm:text-3xl font-bold text-primary-dark dark:text-primary-light">Smart Pantry Scan</h1>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button id="theme-toggle" class="p-2 rounded-full bg-secondary-light dark:bg-tertiary-dark text-primary-dark dark:text-primary-light custom-focus-ring transition-colors duration-300">
                        <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
                </div>
            </header>

            <!-- Filters -->
            <div class="bg-primary-light dark:bg-tertiary-dark p-4 rounded-lg shadow-md mb-6">
                <details open>
                    <summary class="font-semibold text-lg cursor-pointer text-primary-dark dark:text-primary-light flex justify-between items-center">
                        <span>Filters & Search</span>
                        <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div id="filters" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="search" class="block text-sm font-medium text-neutral-dark dark:text-neutral-light mb-1">Search by Name</label>
                            <input type="text" id="search" placeholder="e.g., Laptop" class="w-full p-2 rounded-md bg-white dark:bg-tertiary-dark border border-tertiary-light dark:border-neutral-light custom-focus-ring dark:placeholder-neutral-light">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-neutral-dark dark:text-neutral-light mb-1">Storage Location</label>
                            <div id="locationFilters" class="max-h-24 overflow-y-auto space-y-1 p-2 bg-white dark:bg-tertiary-dark rounded-md border border-tertiary-light dark:border-tertiary-dark">
                            </div>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="showSpoiled" class="mr-2 h-4 w-4 text-primary-dark focus:ring-primary-dark border-gray-300 rounded">
                            <label for="showSpoiled" class="text-sm font-medium text-neutral-dark dark:text-neutral-light">Show Spoiled</label>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="showExpiringSoon" class="mr-2 h-4 w-4 text-primary-dark focus:ring-primary-dark border-gray-300 rounded">
                            <label for="showExpiringSoon" class="text-sm font-medium text-neutral-dark dark:text-neutral-light">Expiring in</label>
                            <input type="number" id="expiringDays" value="3" min="1" class="ml-2 w-16 p-1 rounded-md bg-white dark:bg-tertiary-dark border border-tertiary-light dark:border-neutral-light custom-focus-ring text-center">
                            <span class="ml-1 text-sm font-medium text-neutral-dark dark:text-neutral-light">days</span>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button id="clearAllFiltersBtn" class="bg-error hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 custom-focus-ring">
                            Clear Filters
                        </button>
                    </div>
                </details>
            </div>

            <!-- Inventory Table -->
            <div id="inventory-table-container" class="bg-primary-light dark:bg-tertiary-dark rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[640px]">
                        <thead class="bg-secondary-light dark:bg-tertiary-dark">
                            <tr>
                                <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider"><input type="checkbox" id="selectAllCheckbox" class="h-4 w-4 text-primary-dark focus:ring-primary-dark border-gray-300 rounded"></th>
                                <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider cursor-pointer" data-sort="name">Name</th>
                                <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider cursor-pointer" data-sort="amountRemaining">Amount Remaining</th>
                                <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider cursor-pointer" data-sort="spoilage">Spoilage in</th>
                                <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider cursor-pointer hidden-sm" data-sort="dateAdded">Added</th>
                                <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider cursor-pointer hidden-sm" data-sort="location">Location</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body"></tbody>
                    </table>
                </div>
                <div id="no-results" class="hidden text-center p-8 text-neutral-dark dark:text-neutral-light">
                    <p class="text-lg font-medium">No items found.</p>
                    <p class="text-sm">Try adjusting your filters or add a new item.</p>
                </div>
            </div>

            <!-- Inventory Cards (for mobile) -->
            <div id="inventory-cards" class="grid grid-cols-1 gap-4 mt-6 hidden">
                <div id="inventory-card-list" class="grid grid-cols-1 gap-4">
                    <!-- Cards will be rendered here -->
                </div>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="mt-6 flex justify-between items-center flex-wrap gap-2"></div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-primary-light dark:bg-secondary-dark rounded-lg shadow-xl w-full max-w-md p-6 modal-enter">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-primary-dark dark:text-primary-light">Add New Item</h2>
            <form id="itemForm">
                <input type="hidden" id="itemId">
                <input type="hidden" id="itemBarcode">
                <div class="mb-4">
                    <label for="itemName" class="block text-sm font-medium mb-1">Item Name</label>
                    <input type="text" id="itemName" required class="w-full p-2 rounded-md bg-white dark:bg-tertiary-dark border border-tertiary-light dark:border-tertiary-dark custom-focus-ring">
                </div>
                <div id="continuousQuantityInput" class="mb-4">
                    <label for="itemQuantityNumeric" class="block text-sm font-medium mb-1">Quantity</label>
                    <input type="number" id="itemQuantityNumeric" required min="0" class="w-full p-2 rounded-md bg-white dark:bg-tertiary-dark border border-tertiary-light dark:border-tertiary-dark custom-focus-ring">
                </div>
                <div id="itemUnitInput" class="mb-4">
                    <label for="itemUnit" class="block text-sm font-medium mb-1">Unit</label>
                    <input type="text" id="itemUnit" class="w-full p-2 rounded-md bg-white dark:bg-tertiary-dark border border-tertiary-light dark:border-tertiary-dark custom-focus-ring">
                </div>
                <div id="discreteQuantityCounter" class="mb-4 hidden">
                    <label for="discreteItemQuantity" class="block text-sm font-medium mb-1">Number of Items</label>
                    <div class="flex items-center space-x-2">
                        <button type="button" id="decrementDiscreteQuantity" class="p-2 bg-gray-200 dark:bg-gray-700 rounded-md text-neutral-dark dark:text-neutral-light custom-focus-ring">-</button>
                        <input type="number" id="discreteItemQuantity" min="0" value="1" class="w-20 p-2 text-center rounded-md bg-white dark:bg-tertiary-dark border border-tertiary-light dark:border-tertiary-dark custom-focus-ring">
                        <button type="button" id="incrementDiscreteQuantity" class="p-2 bg-gray-200 dark:bg-gray-700 rounded-md text-neutral-dark dark:text-neutral-light custom-focus-ring">+</button>
                    </div>
                </div>
                <div class="mb-4 flex items-center">
                    <input type="checkbox" id="isDiscrete" class="mr-2 h-4 w-4 text-primary-dark focus:ring-primary-dark border-gray-300 rounded">
                    <label for="isDiscrete" class="text-sm font-medium">Is Discrete Item (e.g., 6 bananas, not 1L milk)</label>
                </div>
                <div id="remainingQuantitySliderContainer" class="mb-4" style="display: none;">
                    <label for="remainingRatio" class="block text-sm font-medium mb-1">Amount Remaining: <span id="remainingRatioValue">100%</span></label>
                    <input type="range" id="remainingRatio" min="0" max="100" value="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                </div>
                <div class="mb-4">
                    <label for="itemLocation" class="block text-sm font-medium mb-1">Storage Location</label>
                    <input type="text" id="itemLocation" placeholder="e.g., Pantry" required class="w-full p-2 rounded-md bg-white dark:bg-tertiary-dark border border-tertiary-light dark:border-tertiary-dark custom-focus-ring" list="location-list">
                    <datalist id="location-list"></datalist>
                </div>
                <div class="mb-4">
                    <label for="dateAddedInput" class="block text-sm font-medium mb-1">Date Added</label>
                    <input type="date" id="dateAddedInput" required class="w-full p-2 rounded-md bg-white dark:bg-tertiary-dark border border-tertiary-light dark:border-tertiary-dark custom-focus-ring">
                </div>
                <div class="mb-6">
                    <label for="perishableDateInput" class="block text-sm font-medium mb-1">Perishable Date</label>
                    <div class="flex items-center space-x-2">
                        <input type="date" id="perishableDateInput" class="w-full p-2 rounded-md bg-white dark:bg-tertiary-dark border border-tertiary-light dark:border-tertiary-dark custom-focus-ring">
                        <button type="button" id="quickAdd3Days" class="p-2 bg-gray-200 dark:bg-gray-700 rounded-md text-sm custom-focus-ring whitespace-nowrap">+3 Days</button>
                        <button type="button" id="quickAdd7Days" class="p-2 bg-gray-200 dark:bg-gray-700 rounded-md text-sm custom-focus-ring whitespace-nowrap">+7 Days</button>
                        <button type="button" id="quickAdd1Month" class="p-2 bg-gray-200 dark:bg-gray-700 rounded-md text-sm custom-focus-ring whitespace-nowrap">+1 Month</button>
                    </div>
                </div>
                <div class="flex justify-between space-x-4">
                    <div>
                        <button type="button" id="deleteItemBtn" class="py-2 px-4 rounded-lg bg-error text-white font-bold hidden">Delete</button>
                    </div>
                    <div class="flex space-x-4">
                        <button type="button" id="cancelBtn" class="py-2 px-4 rounded-lg bg-neutral-light dark:bg-neutral-dark">Cancel</button>
                        <button type="submit" id="saveBtn" class="py-2 px-6 rounded-lg bg-primary-dark text-white font-bold">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Interaction Modal -->
    <div id="interactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-primary-light dark:bg-secondary-dark rounded-lg shadow-xl w-full max-w-md p-6 modal-enter">
            <h2 id="interactionModalTitle" class="text-2xl font-bold mb-4 text-primary-dark dark:text-primary-light">Found Matching Items</h2>
            <div id="interactionList" class="space-y-3 mb-6 max-h-60 overflow-y-auto">
                <!-- Matching items will be injected here -->
            </div>
            <div class="flex justify-between">
                <button type="button" id="interactionAddNewBtn" class="py-2 px-4 rounded-lg bg-green-600 text-white font-bold">Add as New</button>
                <button type="button" id="interactionCancelBtn" class="py-2 px-4 rounded-lg bg-neutral-light dark:bg-neutral-dark">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-primary-light dark:bg-secondary-dark rounded-lg shadow-xl w-full max-w-sm p-6 modal-enter">
            <h2 id="confirmModalTitle" class="text-xl font-bold mb-4 text-primary-dark dark:text-primary-light">Confirm Deletion</h2>
            <p class="mb-6">Are you sure you want to delete this item? This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="confirmCancelBtn" class="py-2 px-4 rounded-lg bg-neutral-light dark:bg-neutral-dark">Cancel</button>
                <button id="confirmDeleteBtn" class="py-2 px-4 rounded-lg bg-error text-white font-bold">Delete</button>
            </div>
        </div>
    </div>

    <!-- Barcode Scan Modal -->
    <div id="barcodeScanModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-primary-light dark:bg-secondary-dark rounded-lg shadow-xl w-full max-w-2xl p-6 modal-enter space-y-4">
            <h2 class="text-2xl font-bold text-primary-dark dark:text-primary-light">Scan Barcode</h2>
            <div class="bg-gray-900 rounded-lg flex justify-center items-center relative overflow-hidden">
                <video id="barcodeVideo" class="w-full"></video>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="w-3/4 h-1/2 border-2 border-green-500 rounded-lg opacity-75"></div>
                </div>
            </div>
            <div id="barcode-status-container" class="p-4 rounded-lg text-center bg-white dark:bg-tertiary-dark">
                <p id="barcodeStatus" class="font-medium">Searching for barcode...</p>
            </div>
            <div class="flex justify-center space-x-4">
                <button type="button" id="toggleFlashlightBtn" class="py-2 px-4 rounded-lg bg-gray-500 text-white font-bold hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.316 1.018a.75.75 0 01.784.068l5.5 4.5A.75.75 0 0118 6.75v6.5a.75.75 0 01-.394.655l-5.5 3.5A.75.75 0 0112 17.25v-3.072l-1.47 1.47a.75.75 0 01-1.06-1.06l2.75-2.75a.75.75 0 011.06 0l2.75 2.75a.75.75 0 01-1.06 1.06l-1.47-1.47V17.25a.75.75 0 01-.394-.655l-5.5-3.5A.75.75 0 012 13.25v-6.5a.75.75 0 01.394-.655l5.5-4.5a.75.75 0 01.784-.068zM12 12.928V6.75H6.75v6.178l5.25 3.357V12.928z" clip-rule="evenodd" />
                    </svg>
                    Flashlight
                </button>
                <button type="button" id="cancelBarcodeScanBtn" class="py-2 px-4 rounded-lg bg-neutral-light dark:bg-neutral-dark">Cancel</button>
            </div>
        </div>
    </div> <!-- Closing div for id="app" -->

    <!-- Floating Action Buttons -->
    <div class="fixed bottom-4 right-4 flex flex-col space-y-3 z-40">
        <button id="deleteSelectedBtn" class="flex items-center bg-error hover:bg-red-700 text-white font-bold py-3 px-5 rounded-full shadow-lg transition-all duration-300 custom-focus-ring hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
        </button>
        <button id="scanBarcodeBtn" class="flex items-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-full shadow-lg transition-all duration-300 custom-focus-ring">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2 6h2v12H2V6zm3 0h1v12H5V6zm2 0h2v12H7V6zm3 0h1v12h-1V6zm2 0h2v12h-2V6zm3 0h1v12h-1V6zm2 0h3v12h-3V6z"/>
            </svg>
        </button>
        <button id="addItemBtn" class="flex items-center bg-primary-dark hover:bg-tertiary-dark text-white font-bold py-3 px-5 rounded-full shadow-lg transition-all duration-300 custom-focus-ring">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
        </button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const inventoryApp = {
                inventory: [],
                filteredInventory: [],
                currentPage: 1,
                itemsPerPage: 10,
                sortConfig: { key: 'dateAdded', direction: 'desc' },
                itemToDeleteId: null,
                selectedItems: [],
                selectedLocationFilters: [], // New array to store selected locations
                showSpoiled: false,
                showExpiringSoon: false,
                expiringDays: 3,

                init() {
                    this.initDOMElements();
                    this.loadTheme();
                    this.loadInventory();
                    this.addEventListeners();
                    this.render();
                    window.barcodeScannerApp.init(this);
                },

                initDOMElements() {
                    this.themeToggle = document.getElementById('theme-toggle');
                    this.addItemBtn = document.getElementById('addItemBtn');
                    this.scanBarcodeBtn = document.getElementById('scanBarcodeBtn');
                    this.itemModal = document.getElementById('itemModal');
                    this.scanModal = document.getElementById('scanModal');
                    this.barcodeScanModal = document.getElementById('barcodeScanModal');
                    this.confirmModal = document.getElementById('confirmModal');
                    this.cancelBtn = document.getElementById('cancelBtn');
                    this.cancelScanBtn = document.getElementById('cancelScanBtn');
                    this.cancelBarcodeScanBtn = document.getElementById('cancelBarcodeScanBtn');
                    this.interactionModal = document.getElementById('interactionModal');
                    this.interactionList = document.getElementById('interactionList');
                    this.interactionCancelBtn = document.getElementById('interactionCancelBtn');
                    this.interactionAddNewBtn = document.getElementById('interactionAddNewBtn');
                    this.confirmCancelBtn = document.getElementById('confirmCancelBtn');
                    this.confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
                    this.selectAllCheckbox = document.getElementById('selectAllCheckbox');
                    this.deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
                    this.itemForm = document.getElementById('itemForm');
                    this.itemQuantityNumeric = document.getElementById('itemQuantityNumeric');
                    this.itemUnit = document.getElementById('itemUnit');
                    this.tableBody = document.getElementById('inventory-table-body');
                    this.inventoryTableContainer = document.getElementById('inventory-table-container'); // New
                    this.inventoryCardsContainer = document.getElementById('inventory-cards'); // New
                    this.inventoryCardList = document.getElementById('inventory-card-list'); // New
                    this.paginationContainer = document.getElementById('pagination');
                    this.filterInputs = document.querySelectorAll('#filters input, #filters select');
                    this.locationFiltersContainer = document.getElementById('locationFilters');
                    this.locationDatalist = document.getElementById('location-list');
                    this.noResultsDiv = document.getElementById('no-results');
                    this.barcodeVideo = document.getElementById('barcodeVideo');
                    this.barcodeStatusEl = document.getElementById('barcodeStatus');
                    this.toggleFlashlightBtn = document.getElementById('toggleFlashlightBtn');
                    this.isDiscrete = document.getElementById('isDiscrete');
                    this.continuousQuantityInput = document.getElementById('continuousQuantityInput');
                    this.itemUnitInput = document.getElementById('itemUnitInput');
                    this.discreteQuantityCounter = document.getElementById('discreteQuantityCounter');
                    this.discreteItemQuantity = document.getElementById('discreteItemQuantity');
                    this.decrementDiscreteQuantity = document.getElementById('decrementDiscreteQuantity');
                    this.incrementDiscreteQuantity = document.getElementById('incrementDiscreteQuantity');
                    this.remainingQuantitySliderContainer = document.getElementById('remainingQuantitySliderContainer');
                    this.remainingRatio = document.getElementById('remainingRatio');
                    this.remainingRatioValue = document.getElementById('remainingRatioValue');
                    this.dateAddedInput = document.getElementById('dateAddedInput');
                    this.perishableDateInput = document.getElementById('perishableDateInput');
                    this.quickAdd3Days = document.getElementById('quickAdd3Days');
                    this.quickAdd7Days = document.getElementById('quickAdd7Days');
                    this.quickAdd1Month = document.getElementById('quickAdd1Month');
                    this.clearAllFiltersBtn = document.getElementById('clearAllFiltersBtn');
                    this.deleteItemBtn = document.getElementById('deleteItemBtn');
                    this.showSpoiledCheckbox = document.getElementById('showSpoiled');
                    this.showExpiringSoonCheckbox = document.getElementById('showExpiringSoon');
                    this.expiringDaysInput = document.getElementById('expiringDays');
                },

                addEventListeners() {
                    this.themeToggle.addEventListener('click', () => this.toggleTheme());
                    this.addItemBtn.addEventListener('click', () => this.openItemForm());
                    this.scanBarcodeBtn.addEventListener('click', () => window.barcodeScannerApp.startScan());
                    this.cancelBtn.addEventListener('click', () => this.closeModal(this.itemModal));
                    this.cancelBarcodeScanBtn.addEventListener('click', () => window.barcodeScannerApp.stopScan());
                    this.toggleFlashlightBtn.addEventListener('click', () => window.barcodeScannerApp.toggleFlashlight());
                    this.itemForm.addEventListener('submit', (e) => this.handleFormSubmit(e));
                    this.interactionCancelBtn.addEventListener('click', () => this.closeModal(this.interactionModal));
                    this.interactionAddNewBtn.addEventListener('click', () => this.addNewItemFromInteraction());
                    this.interactionList.addEventListener('click', (e) => this.handleInteraction(e));
                    this.confirmCancelBtn.addEventListener('click', () => this.closeModal(this.confirmModal));
                    this.confirmDeleteBtn.addEventListener('click', () => this.handleDelete());
                    this.selectAllCheckbox.addEventListener('change', (e) => this.toggleAllCheckboxes(e.target.checked));
                    this.deleteSelectedBtn.addEventListener('click', () => this.openConfirmDeleteSelectedModal());
                    this.tableBody.addEventListener('click', (e) => this.handleTableActions(e));
                    this.inventoryCardsContainer.addEventListener('click', (e) => this.handleCardActions(e)); // New
                    // Long press for cards
                    let pressTimer;
                    const longPressDuration = 700; // milliseconds

                    this.inventoryCardList.addEventListener('touchstart', (e) => {
                        const card = e.target.closest('.bg-primary-light.dark\\:bg-tertiary-dark.rounded-lg.shadow-md.p-4.relative.cursor-pointer');
                        if (card) {
                            pressTimer = setTimeout(() => {
                                console.log('Long press detected on card:', card.dataset.id);
                                const itemId = parseInt(card.dataset.id, 10);
                                if (this.selectedItems.includes(itemId)) {
                                    this.showClearSelectionOptions(itemId); // New function for selected item long press
                                } else {
                                    this.showSelectAllConfirmation(); // Existing function for unselected item long press
                                }
                                pressTimer = null;
                            }, longPressDuration);
                        }
                    });

                    this.inventoryCardList.addEventListener('touchend', (e) => {
                        clearTimeout(pressTimer);
                        // Prevent click event from firing if it was a long press
                        if (pressTimer === null) {
                            e.preventDefault();
                        }
                    });

                    this.inventoryCardList.addEventListener('mousedown', (e) => {
                        const card = e.target.closest('.bg-primary-light.dark\\:bg-tertiary-dark.rounded-lg.shadow-md.p-4.relative.cursor-pointer');
                        if (card) {
                            pressTimer = setTimeout(() => {
                                console.log('Long press detected on card:', card.dataset.id);
                                const itemId = parseInt(card.dataset.id, 10);
                                if (this.selectedItems.includes(itemId)) {
                                    this.showClearSelectionOptions(itemId); // New function for selected item long press
                                } else {
                                    this.showSelectAllConfirmation(); // Existing function for unselected item long press
                                }
                                pressTimer = null;
                            }, longPressDuration);
                        }
                    });

                    this.inventoryCardList.addEventListener('mouseup', (e) => {
                        clearTimeout(pressTimer);
                        // Prevent click event from firing if it was a long press
                        if (pressTimer === null) {
                            e.preventDefault();
                        }
                    });

                    this.inventoryCardList.addEventListener('contextmenu', (e) => {
                        const card = e.target.closest('.bg-primary-light.dark\\:bg-tertiary-dark.rounded-lg.shadow-md.p-4.relative.cursor-pointer');
                        if (card && pressTimer === null) { // Only prevent if long press was handled
                            e.preventDefault(); // Prevent default context menu on long press
                        }
                    });

                    this.paginationContainer.addEventListener('click', (e) => this.handlePaginationClick(e));
                    document.querySelector('thead').addEventListener('click', (e) => this.handleSort(e));
                    this.filterInputs.forEach(input => input.addEventListener('input', (e) => this.handleFilterChange(e)));
                    this.locationFiltersContainer.addEventListener('change', (e) => this.handleFilterChange(e));
                    this.clearAllFiltersBtn.addEventListener('click', () => this.clearAllFilters());
                    this.deleteItemBtn.addEventListener('click', () => this.openConfirmModal(document.getElementById('itemId').value));
                    this.showSpoiledCheckbox.addEventListener('change', (e) => this.handleFilterChange(e));
                    this.showExpiringSoonCheckbox.addEventListener('change', (e) => this.handleFilterChange(e));
                    this.expiringDaysInput.addEventListener('input', (e) => this.handleFilterChange(e));

                    // New event listeners for remaining quantity slider and discrete item quantity
                    this.isDiscrete.addEventListener('change', () => {
                        if (this.isDiscrete.checked) {
                            this.continuousQuantityInput.classList.add('hidden');
                            this.itemUnitInput.classList.add('hidden');
                            this.discreteQuantityCounter.classList.remove('hidden');
                            this.remainingQuantitySliderContainer.style.display = 'none';
                        } else {
                            this.continuousQuantityInput.classList.remove('hidden');
                            this.itemUnitInput.classList.remove('hidden');
                            this.discreteQuantityCounter.classList.add('hidden');
                            this.remainingQuantitySliderContainer.style.display = 'block';
                        }
                    });
                    this.remainingRatio.addEventListener('input', () => {
                        this.remainingRatioValue.textContent = `${this.remainingRatio.value}%`;
                    });
                    this.decrementDiscreteQuantity.addEventListener('click', () => {
                        let currentValue = parseInt(this.discreteItemQuantity.value, 10);
                        if (currentValue > 0) {
                            this.discreteItemQuantity.value = currentValue - 1;
                        }
                    });
                    this.incrementDiscreteQuantity.addEventListener('click', () => {
                        let currentValue = parseInt(this.discreteItemQuantity.value, 10);
                        this.discreteItemQuantity.value = currentValue + 1;
                    });

                    this.quickAdd3Days.addEventListener('click', () => this.handleQuickAdd(3, 'days'));
                    this.quickAdd7Days.addEventListener('click', () => this.handleQuickAdd(7, 'days'));
                    this.quickAdd1Month.addEventListener('click', () => this.handleQuickAdd(1, 'months'));
                },

                clearAllFilters() {
                    document.getElementById('search').value = '';
                    this.selectedLocationFilters = [];
                    this.showSpoiled = false;
                    this.showExpiringSoon = false;
                    this.expiringDays = 3;
                    document.getElementById('showSpoiled').checked = false;
                    document.getElementById('showExpiringSoon').checked = false;
                    document.getElementById('expiringDays').value = 3;
                    this.currentPage = 1;
                    this.render();
                },
                
                loadTheme() {
                    const isDark = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
                    document.documentElement.classList.toggle('dark', isDark);
                    document.getElementById('theme-icon-light').classList.toggle('hidden', isDark);
                    document.getElementById('theme-icon-dark').classList.toggle('hidden', !isDark);
                },

                toggleTheme() {
                    const isDark = document.documentElement.classList.toggle('dark');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    this.loadTheme();
                },

                loadInventory() {
                    const stored = localStorage.getItem('inventory');
                    if (stored) {
                        this.inventory = JSON.parse(stored);
                    } else {
                        // Default food-related inventory items
                        this.inventory = [
                            { id: 1, name: 'Milk', quantity: 1, unit: 'Liter', isDiscrete: false, remainingRatio: 0.75, location: 'Refrigerator', dateAdded: '2025-09-28T10:00:00Z', perishableDate: '2025-10-26T10:00:00Z' },
                            { id: 2, name: 'Bananas', quantity: 6, unit: 'units', isDiscrete: true, remainingRatio: 1, location: 'Counter', dateAdded: '2025-09-29T11:30:00Z', perishableDate: '2025-10-24T11:30:00Z' },
                            { id: 3, name: 'Canned Tomatoes', quantity: 2, unit: 'cans', isDiscrete: true, remainingRatio: 1, location: 'Pantry', dateAdded: '2025-09-25T14:00:00Z', perishableDate: '2026-09-25T14:00:00Z' },
                            { id: 4, name: 'Eggs', quantity: 12, unit: 'units', isDiscrete: true, remainingRatio: 1, location: 'Refrigerator', dateAdded: '2025-09-20T09:00:00Z', perishableDate: '2025-10-11T09:00:00Z' },
                            { id: 5, name: 'Bread', quantity: 1, unit: 'loaf', isDiscrete: false, remainingRatio: 0.5, location: 'Pantry', dateAdded: '2025-09-30T16:00:00Z', perishableDate: '2025-10-07T16:00:00Z' },
                            { id: 6, name: 'Yogurt', quantity: 4, unit: 'cups', isDiscrete: true, remainingRatio: 1, location: 'Refrigerator', dateAdded: '2025-09-27T08:00:00Z', perishableDate: '2025-10-11T08:00:00Z' },
                            { id: 7, name: 'Coffee Beans', quantity: 500, unit: 'grams', isDiscrete: false, remainingRatio: 0.8, location: 'Pantry', dateAdded: '2025-09-26T13:00:00Z', perishableDate: '2025-12-25T13:00:00Z' },
                            { id: 8, name: 'Apples', quantity: 5, unit: 'units', isDiscrete: true, remainingRatio: 1, location: 'Counter', dateAdded: '2025-09-24T10:00:00Z', perishableDate: '2025-10-08T10:00:00Z' },
                            { id: 9, name: 'Cheese', quantity: 200, unit: 'grams', isDiscrete: false, remainingRatio: 0.6, location: 'Refrigerator', dateAdded: '2025-09-23T15:00:00Z', perishableDate: '2025-10-23T15:00:00Z' },
                            { id: 10, name: 'Pasta', quantity: 1, unit: 'box', isDiscrete: true, remainingRatio: 1, location: 'Pantry', dateAdded: '2025-09-22T12:00:00Z', perishableDate: '2027-09-22T12:00:00Z' },
                        ];
                    }
                },

                saveInventory() {
                    localStorage.setItem('inventory', JSON.stringify(this.inventory));
                },

                openModal(modal) {
                    modal.classList.remove('hidden');
                    modal.firstElementChild.classList.add('modal-enter-active');
                },

                closeModal(modal) {
                    modal.firstElementChild.classList.remove('modal-enter-active');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        // Explicitly remove deselectThisBtn if it exists when confirmModal closes
                        if (modal.id === 'confirmModal') {
                            const deselectThisBtn = document.getElementById('deselectThisBtn');
                            if (deselectThisBtn) {
                                deselectThisBtn.remove();
                                console.log('deselectThisBtn removed from DOM.');
                            }
                        }
                    }, 300);
                },

                openItemForm(item = null) {
                    this.itemForm.reset();
                    document.getElementById('modalTitle').textContent = item ? 'Edit Item' : 'Add New Item';
                    const itemIdInput = document.getElementById('itemId');
                    const itemBarcodeInput = document.getElementById('itemBarcode');
                    itemIdInput.value = item ? item.id : '';
                    itemBarcodeInput.value = item ? item.barcode : '';
                    if (item) {
                        document.getElementById('itemName').value = item.name;
                        document.getElementById('itemLocation').value = item.location;
                        document.getElementById('isDiscrete').checked = item.isDiscrete || false;

                        if (item.isDiscrete) {
                            this.continuousQuantityInput.classList.add('hidden');
                            this.itemUnitInput.classList.add('hidden');
                            this.discreteQuantityCounter.classList.remove('hidden');
                            this.discreteItemQuantity.value = item.quantity;
                            this.remainingQuantitySliderContainer.style.display = 'none';
                        } else {
                            this.continuousQuantityInput.classList.remove('hidden');
                            this.itemUnitInput.classList.remove('hidden');
                            this.discreteQuantityCounter.classList.add('hidden');
                            document.getElementById('itemQuantityNumeric').value = item.quantity;
                            document.getElementById('itemUnit').value = item.unit || '';
                            this.remainingRatio.value = (item.remainingRatio !== undefined) ? (item.remainingRatio * 100) : 100;
                            this.remainingRatioValue.textContent = `${this.remainingRatio.value}%`;
                            this.remainingQuantitySliderContainer.style.display = 'block';
                        }

                        this.dateAddedInput.value = item.dateAdded ? item.dateAdded.split('T')[0] : '';
                        this.perishableDateInput.value = item.perishableDate ? item.perishableDate.split('T')[0] : '';
                        this.deleteItemBtn.classList.remove('hidden'); // Show delete button for existing items
                    } else {
                        // For new items, default to continuous input visible, discrete hidden
                        document.getElementById('isDiscrete').checked = false;
                        this.continuousQuantityInput.classList.remove('hidden');
                        this.itemUnitInput.classList.remove('hidden');
                        this.discreteQuantityCounter.classList.add('hidden');
                        document.getElementById('itemQuantityNumeric').value = 1; // Default quantity for new continuous item
                        document.getElementById('itemUnit').value = '';
                        this.remainingRatio.value = 100;
                        this.remainingRatioValue.textContent = '100%';
                        this.remainingQuantitySliderContainer.style.display = 'block';
                        this.dateAddedInput.valueAsDate = new Date(); // Default to current date for new item
                        this.perishableDateInput.value = ''; // Clear for new item
                        this.deleteItemBtn.classList.add('hidden'); // Hide delete button for new items
                    }
                    this.openModal(this.itemModal);
                },
                
                openConfirmModal(id) {
                    console.log('openConfirmModal called with ID:', id);
                    this.itemToDeleteId = id;
                    this.openModal(this.confirmModal);
                },

                handleQuickAdd(amount, unit) {
                    const date = new Date(this.perishableDateInput.value || new Date());
                    if (unit === 'days') {
                        date.setDate(date.getDate() + amount);
                    } else if (unit === 'months') {
                        date.setMonth(date.getMonth() + amount);
                    }
                    this.perishableDateInput.valueAsDate = date;
                },

                handleFormSubmit(e) {
                    e.preventDefault();
                    const id = document.getElementById('itemId').value;
                    const isDiscrete = document.getElementById('isDiscrete').checked;

                    let quantityValue;
                    let unitValue;
                    let remainingRatioValue;

                    if (isDiscrete) {
                        quantityValue = parseInt(this.discreteItemQuantity.value, 10);
                        unitValue = ''; // Discrete items don't typically have units like 'Liters'
                        remainingRatioValue = 1; // Discrete items are either there or not, so remaining is always 100%
                    } else {
                        quantityValue = parseInt(document.getElementById('itemQuantityNumeric').value, 10);
                        unitValue = document.getElementById('itemUnit').value;
                        remainingRatioValue = (parseInt(document.getElementById('remainingRatio').value, 10) / 100);
                    }

                    const newItem = {
                        barcode: document.getElementById('itemBarcode').value,
                        name: document.getElementById('itemName').value,
                        quantity: quantityValue,
                        unit: unitValue,
                        isDiscrete: isDiscrete,
                        remainingRatio: remainingRatioValue,
                        location: document.getElementById('itemLocation').value,
                        dateAdded: new Date(document.getElementById('dateAddedInput').value).toISOString(),
                        perishableDate: document.getElementById('perishableDateInput').value ? new Date(document.getElementById('perishableDateInput').value).toISOString() : null,
                        lastModified: new Date().toISOString(),
                    };
                    if (id) {
                        const index = this.inventory.findIndex(item => item.id == id);
                        if (index !== -1) this.inventory[index] = { ...this.inventory[index], ...newItem };
                    } else {
                        newItem.id = Date.now();
                        newItem.dateAdded = new Date().toISOString();
                        this.inventory.push(newItem);
                    }
                    this.saveInventory();
                    this.render();
                    this.closeModal(this.itemModal);
                },

                handleDelete() {
                    console.log('Attempting to delete item with ID:', this.itemToDeleteId);
                    const idToDelete = parseInt(this.itemToDeleteId, 10);
                    this.inventory = this.inventory.filter(item => item.id !== idToDelete);
                    this.saveInventory();
                    this.render();
                    this.closeModal(this.confirmModal);
                    this.closeModal(this.itemModal); // Close the itemModal after deletion
                },
                
                handleTableActions(e) {
                    const itemCheckbox = e.target.closest('.item-checkbox');
                    if (itemCheckbox) {
                        this.handleItemCheckboxChange(parseInt(itemCheckbox.dataset.id, 10), itemCheckbox.checked);
                        return; // Prevent row click from firing if checkbox is clicked
                    }

                    const row = e.target.closest('tr[data-id]');
                    if (row) {
                        const item = this.inventory.find(i => i.id == row.dataset.id);
                        if (item) this.openItemForm(item);
                    }
                },

                handleCardActions(e) {
                    console.log('handleCardActions called');
                    const itemCheckbox = e.target.closest('.item-checkbox');
                    if (itemCheckbox) {
                        this.handleItemCheckboxChange(parseInt(itemCheckbox.dataset.id, 10), itemCheckbox.checked);
                        return; // Prevent card click from firing if checkbox is clicked
                    }

                    const card = e.target.closest('.bg-primary-light.dark\\:bg-tertiary-dark.rounded-lg.shadow-md.p-4.relative.cursor-pointer');
                    if (card) {
                        const item = this.inventory.find(i => i.id == card.dataset.id);
                        if (item) this.openItemForm(item);
                    }
                },
                
                handlePaginationClick(e) {
                    const pageBtn = e.target.closest('.page-btn');
                    if (pageBtn && !pageBtn.disabled) {
                        this.currentPage = parseInt(pageBtn.dataset.page, 10);
                        this.render();
                    }
                },
                
                handleSort(e) {
                    const key = e.target.closest('th')?.dataset.sort;
                    if (!key) return;
                    if (this.sortConfig.key === key) {
                        this.sortConfig.direction = this.sortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortConfig.key = key;
                        this.sortConfig.direction = 'asc';
                    }
                    this.currentPage = 1;
                    this.render();
                },
                
                handleFilterChange(e) {
                    const target = e.target;
                    if (target.matches('#locationFilters input[type="checkbox"]')) {
                        const location = target.value;
                        if (target.checked) {
                            if (!this.selectedLocationFilters.includes(location)) {
                                this.selectedLocationFilters.push(location);
                            }
                        } else {
                            this.selectedLocationFilters = this.selectedLocationFilters.filter(loc => loc !== location);
                        }
                    } else if (target.matches('#showSpoiled')) {
                        this.showSpoiled = target.checked;
                    } else if (target.matches('#showExpiringSoon')) {
                        this.showExpiringSoon = target.checked;
                    } else if (target.matches('#expiringDays')) {
                        this.expiringDays = parseInt(target.value, 10);
                    }
                    this.currentPage = 1;
                    this.render();
                },

                render() {
                    console.log('render called');
                    this.applyFiltersAndSort();
                    const isMobileView = window.innerWidth < 768; // Define breakpoint for mobile view
                    console.log('isMobileView:', isMobileView, 'window.innerWidth:', window.innerWidth);

                    if (isMobileView) {
                        console.log('Rendering cards view. Hiding table, showing cards.');
                        this.inventoryTableContainer.classList.add('hidden');
                        this.inventoryCardsContainer.classList.remove('hidden');
                        this.renderCards();
                    } else {
                        console.log('Rendering table view. Showing table, hiding cards.');
                        this.inventoryTableContainer.classList.remove('hidden');
                        this.inventoryCardsContainer.classList.add('hidden');
                        this.renderTable();
                    }
                    this.renderPagination();
                    this.renderLocationFilters();
                    this.renderLocationDatalist();
                },

                applyFiltersAndSort() {
                    const searchTerm = document.getElementById('search').value.toLowerCase();

                    this.filteredInventory = this.inventory.filter(item => {
                    const daysRemaining = item.perishableDate ? Math.floor((new Date(item.perishableDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                    const isSpoiled = daysRemaining !== null && daysRemaining < 0;
                    const isExpiringSoon = this.showExpiringSoon && daysRemaining !== null && daysRemaining >= 0 && daysRemaining <= this.expiringDays;

                        return item.name.toLowerCase().includes(searchTerm) &&
                            (this.selectedLocationFilters.length === 0 || this.selectedLocationFilters.includes(item.location)) &&
                            (!this.showSpoiled || isSpoiled) &&
                            (!this.showExpiringSoon || isExpiringSoon);
                    });

                    this.filteredInventory.sort((a, b) => {
                        let aVal, bVal;

                        if (this.sortConfig.key === 'spoilage') {
                            const aDaysRemaining = a.perishableDate ? Math.floor((new Date(a.perishableDate) - new Date()) / (1000 * 60 * 60 * 24)) : Infinity;
                            const bDaysRemaining = b.perishableDate ? Math.floor((new Date(b.perishableDate) - new Date()) / (1000 * 60 * 60 * 24)) : Infinity;
                            aVal = aDaysRemaining;
                            bVal = bDaysRemaining;
                        } else if (this.sortConfig.key === 'amountRemaining') {
                            aVal = a.isDiscrete ? a.quantity : a.remainingRatio;
                            bVal = b.isDiscrete ? b.quantity : b.remainingRatio;
                        } else {
                            aVal = a[this.sortConfig.key];
                            bVal = b[this.sortConfig.key];
                        }
                        
                        let comparison = (aVal > bVal) ? 1 : (aVal < bVal) ? -1 : 0;
                        return this.sortConfig.direction === 'asc' ? comparison : -comparison;
                    });
                },

                renderTable() {
                    this.tableBody.innerHTML = '';
                    const pageItems = this.filteredInventory.slice((this.currentPage - 1) * this.itemsPerPage, this.currentPage * this.itemsPerPage);
                    this.noResultsDiv.classList.toggle('hidden', pageItems.length > 0);
                    
                    pageItems.forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-secondary-light dark:border-tertiary-dark hover:bg-secondary-light dark:hover:bg-tertiary-dark cursor-pointer';
                        row.dataset.id = item.id; // Add data-id to the row
                        const isSelected = this.selectedItems.includes(item.id);
                        const daysRemaining = item.perishableDate ? Math.floor((new Date(item.perishableDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                        let expiryText = '';
                        if (daysRemaining !== null) {
                            if (daysRemaining < 0) {
                                expiryText = '<span class="text-red-500 font-bold">Expired!</span>';
                            } else if (daysRemaining <= 3) {
                                expiryText = `<span class="text-orange-500 font-bold">${daysRemaining} days left</span>`;
                            }
                            else {
                                expiryText = `${daysRemaining} days left`;
                            }
                        } else {
                            expiryText = 'N/A';
                        }

                        row.innerHTML = `
                            <td class="p-4"><input type="checkbox" class="item-checkbox h-4 w-4 text-primary-dark focus:ring-primary-dark border-gray-300 rounded" data-id="${item.id}" ${isSelected ? 'checked' : ''}></td>
                            <td class="p-4">${item.name}</td>
                            <td class="p-4">
                                ${item.isDiscrete ? 
                                    `<span>${item.quantity}</span>` : 
                                    `<div class="flex items-center">
                                        <div class="w-24 bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${item.remainingRatio * 100}%" title="${(item.remainingRatio * 100).toFixed(0)}% Remaining"></div>
                                        </div>
                                        <span class="text-sm ml-2">${(item.remainingRatio * 100).toFixed(0)}%</span>
                                    </div>`
                                }
                            </td>
                            <td class="p-4">${expiryText}</td>
                            <td class="p-4 hidden-sm">${new Date(item.dateAdded).toLocaleDateString()}</td>
                            <td class="p-4 hidden-sm">${item.location}</td>`;
                        this.tableBody.appendChild(row);
                    });
                },

                                renderCards() {

                                    console.log('renderCards called');

                                    this.inventoryCardList.innerHTML = ''; // Changed to inventoryCardList

                                    console.log('inventoryCardList innerHTML cleared.'); // New log

                                    const pageItems = this.filteredInventory.slice((this.currentPage - 1) * this.itemsPerPage, this.currentPage * this.itemsPerPage);

                                    

                                    if (pageItems.length === 0) {

                                        console.log('No items to render in cards view.');

                                        this.inventoryCardsContainer.classList.add('hidden'); // Still hide the main container if no items

                                        this.noResultsDiv.classList.remove('hidden');

                                        return;

                                    } else {

                                        console.log('Rendering', pageItems.length, 'cards.');

                                        this.inventoryCardsContainer.classList.remove('hidden');

                                        this.noResultsDiv.classList.add('hidden');

                                    }

                

                                    pageItems.forEach(item => {

                                        const isSelected = this.selectedItems.includes(item.id);

                                        const daysRemaining = item.perishableDate ? Math.floor((new Date(item.perishableDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;

                                        let expiryText = '';

                                        if (daysRemaining !== null) {

                                            if (daysRemaining < 0) {

                                                expiryText = '<span class="text-red-500 font-bold">Expired!</span>';

                                            } else if (daysRemaining <= 3) {

                                                expiryText = `<span class="text-orange-500 font-bold">${daysRemaining} days left</span>`;

                                            } else {

                                                expiryText = `${daysRemaining} days left`;

                                            }

                                        } else {

                                            expiryText = 'N/A';

                                        }

                

                                        const card = document.createElement('div');

                                        card.className = 'bg-primary-light dark:bg-tertiary-dark rounded-lg shadow-md p-4 relative cursor-pointer';

                                        card.dataset.id = item.id;

                

                                        card.innerHTML = `

                                            <div class="absolute top-2 right-2">

                                                <input type="checkbox" class="item-checkbox h-4 w-4 text-primary-dark focus:ring-primary-dark border-gray-300 rounded" data-id="${item.id}" ${isSelected ? 'checked' : ''}>

                                            </div>

                                            <h3 class="text-lg font-semibold text-primary-dark dark:text-primary-light mb-1">${item.name}</h3>

                                            <p class="text-sm text-neutral-dark dark:text-neutral-light mb-2">Location: ${item.location}</p>

                                            <div class="mb-2">

                                                <span class="text-sm font-medium text-neutral-dark dark:text-neutral-light">Amount: </span>

                                                ${item.isDiscrete ? 

                                                    `<span>${item.quantity} ${item.unit || ''}</span>` : 

                                                    `<div class="flex items-center mt-1">

                                                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">

                                                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${item.remainingRatio * 100}%" title="${(item.remainingRatio * 100).toFixed(0)}% Remaining"></div>

                                                        </div>

                                                        <span class="text-sm ml-2">${(item.remainingRatio * 100).toFixed(0)}%</span>

                                                    </div>`

                                                }

                                            </div>

                                            <p class="text-sm text-neutral-dark dark:text-neutral-light">Spoilage: ${expiryText}</p>

                                        `;

                                        this.inventoryCardList.appendChild(card); // Changed to inventoryCardList

                                    });

                                                                        },

                renderPagination() {
                    const totalPages = Math.ceil(this.filteredInventory.length / this.itemsPerPage);
                    this.paginationContainer.innerHTML = '';
                    if (totalPages <= 1) return;
                    // Pagination logic here...
                },

                renderLocationFilters() {
                    const locations = [...new Set(this.inventory.map(item => item.location))].sort();
                    this.locationFiltersContainer.innerHTML = locations.map(location => {
                        const isChecked = this.selectedLocationFilters.includes(location);
                        return `
                            <div class="flex items-center">
                                <input type="checkbox" value="${location}" id="loc-${location}" class="h-4 w-4 text-primary-dark focus:ring-primary-dark border-gray-300 rounded" ${isChecked ? 'checked' : ''}>
                                <label for="loc-${location}" class="ml-2 text-sm font-medium text-neutral-dark dark:text-neutral-light">${location}</label>
                            </div>`;
                    }).join('');
                },

                renderLocationDatalist() {
                    const locations = [...new Set(this.inventory.map(item => item.location))];
                    this.locationDatalist.innerHTML = locations.map(location => `<option value="${location}"></option>`).join('');
                },

                // New functions for multi-select and mass delete
                toggleAllCheckboxes(checked) {
                    const checkboxes = document.querySelectorAll('.item-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = checked;
                        this.handleItemCheckboxChange(parseInt(checkbox.dataset.id, 10), checked);
                    });
                },

                toggleAllCardsCheckboxes(forceChecked = null) { // Added forceChecked parameter
                    console.log('toggleAllCardsCheckboxes called with forceChecked:', forceChecked);
                    const allCardCheckboxes = document.querySelectorAll('#inventory-card-list .item-checkbox');
                    console.log('Found', allCardCheckboxes.length, 'card checkboxes.');
                    const allCurrentlyChecked = allCardCheckboxes.length > 0 && Array.from(allCardCheckboxes).every(cb => cb.checked);
                    console.log('Are all cards currently checked?', allCurrentlyChecked);

                    const targetCheckedState = (forceChecked !== null) ? forceChecked : !allCurrentlyChecked;
                    console.log('Target checked state for all cards:', targetCheckedState);
                    
                    allCardCheckboxes.forEach(checkbox => {
                        checkbox.checked = targetCheckedState;
                        console.log('Toggling checkbox for item ID:', checkbox.dataset.id, 'to checked:', targetCheckedState);
                        this.handleItemCheckboxChange(parseInt(checkbox.dataset.id, 10), targetCheckedState);
                    });
                },

                clearAllSelections() {
                    console.log('clearAllSelections called');
                    this.selectedItems = []; // Clear the selected items array
                    // Uncheck all visible checkboxes
                    const allCheckboxes = document.querySelectorAll('.item-checkbox');
                    allCheckboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    this.updateDeleteButtonState(); // Update delete button visibility
                    this.render(); // Re-render to update UI
                },



                handleItemCheckboxChange(itemId, checked) {
                    if (checked) {
                        if (!this.selectedItems.includes(itemId)) {
                            this.selectedItems.push(itemId);
                        }
                    } else {
                        this.selectedItems = this.selectedItems.filter(id => id !== itemId);
                    }
                    this.updateDeleteButtonState();
                    // Update 'Select All' checkbox state (only for table view if applicable)
                    // const allCheckboxes = document.querySelectorAll('.item-checkbox');
                    // const allChecked = allCheckboxes.length > 0 && Array.from(allCheckboxes).every(cb => cb.checked);
                    // this.selectAllCheckbox.checked = allChecked; // This is for the table's select all checkbox
                },

                updateDeleteButtonState() {
                    if (this.selectedItems.length >= 2) {
                        this.deleteSelectedBtn.classList.remove('hidden');
                    } else {
                        this.deleteSelectedBtn.classList.add('hidden');
                    }
                },

                openConfirmDeleteSelectedModal() {
                    if (this.selectedItems.length > 0) {
                        this.openModal(this.confirmModal);
                        document.getElementById('confirmModalTitle').textContent = `Delete ${this.selectedItems.length} Items`;
                        document.querySelector('#confirmModal p').textContent = `Are you sure you want to delete ${this.selectedItems.length} selected items? This action cannot be undone.`;
                        // Temporarily hijack confirmDeleteBtn for mass delete
                        this.confirmDeleteBtn.onclick = () => this.deleteSelectedItems();
                    }
                },

                showSelectAllConfirmation() {
                    console.log('showSelectAllConfirmation called');
                    this.openModal(this.confirmModal);
                    document.getElementById('confirmModalTitle').textContent = 'Select All Items';
                    document.querySelector('#confirmModal p').textContent = 'Do you want to select all visible items?';
                    this.confirmDeleteBtn.textContent = 'Yes, Select All'; // Change button text
                    this.confirmDeleteBtn.onclick = () => {
                        this.toggleAllCardsCheckboxes(true); // Select all
                        this.closeModal(this.confirmModal);
                        // Reset button text after action
                        this.confirmDeleteBtn.textContent = 'Delete';
                    };
                    this.confirmCancelBtn.onclick = () => {
                        this.closeModal(this.confirmModal);
                        // Reset button text after action
                        this.confirmDeleteBtn.textContent = 'Delete';
                    };
                },

                showClearSelectionOptions(itemId) {
                    console.log('showClearSelectionOptions called for item ID:', itemId);
                    this.openModal(this.confirmModal);
                    document.getElementById('confirmModalTitle').textContent = 'Selection Options';
                    document.querySelector('#confirmModal p').innerHTML = 'What would you like to do with the selected items?';

                    // Temporarily change confirmDeleteBtn to "Clear All"
                    this.confirmDeleteBtn.textContent = 'Clear All Selections';
                    this.confirmDeleteBtn.onclick = () => {
                        this.clearAllSelections();
                        this.closeModal(this.confirmModal);
                        this.confirmDeleteBtn.textContent = 'Delete'; // Reset button text
                    };

                    // Add or update button for "Deselect This Item"
                    let deselectThisBtn = document.getElementById('deselectThisBtn');
                    if (!deselectThisBtn) {
                        deselectThisBtn = document.createElement('button');
                        deselectThisBtn.id = 'deselectThisBtn';
                        deselectThisBtn.className = 'py-2 px-4 rounded-lg bg-neutral-light dark:bg-neutral-dark';
                        // Insert deselectThisBtn before confirmCancelBtn
                        this.confirmCancelBtn.parentNode.insertBefore(deselectThisBtn, this.confirmCancelBtn);
                    }
                    deselectThisBtn.textContent = 'Deselect This Item';
                    deselectThisBtn.onclick = () => {
                        console.log('Deselect This Item button clicked for item ID:', itemId);
                        this.handleItemCheckboxChange(itemId, false); // Deselect the specific item
                        this.closeModal(this.confirmModal);
                        this.confirmDeleteBtn.textContent = 'Delete'; // Reset button text
                        this.render(); // Re-render to update UI
                    };

                    // Modify cancel button to just close the modal
                    this.confirmCancelBtn.onclick = () => {
                        this.closeModal(this.confirmModal);
                        this.confirmDeleteBtn.textContent = 'Delete'; // Reset button text
                    };
                },

                openInteractionModal(items, barcode) {
                    this.interactionList.innerHTML = '';
                    items.forEach(item => {
                        const daysRemaining = item.perishableDate ? Math.floor((new Date(item.perishableDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                        let expiryText = '';
                        if (daysRemaining !== null) {
                            if (daysRemaining < 0) {
                                expiryText = '<span class="text-red-500 font-bold">Expired!</span>';
                            } else if (daysRemaining <= 3) {
                                expiryText = `<span class="text-orange-500 font-bold">${daysRemaining} days left</span>`;
                            } else {
                                expiryText = `${daysRemaining} days left`;
                            }
                        } else {
                            expiryText = 'N/A';
                        }

                        const itemElement = document.createElement('div');
                        itemElement.className = 'p-3 bg-white dark:bg-tertiary-dark rounded-lg flex justify-between items-center';
                        itemElement.innerHTML = `
                            <div>
                                <p class="font-semibold">${item.name}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Spoilage: ${expiryText}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Modified: ${new Date(item.lastModified).toLocaleString()}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="edit-item-btn p-2 text-blue-600 hover:text-blue-800" data-id="${item.id}" title="Edit">Edit</button>
                                <button class="delete-item-btn p-2 text-red-600 hover:text-red-800" data-id="${item.id}" title="Delete">Delete</button>
                            </div>
                        `;
                        this.interactionList.appendChild(itemElement);
                    });
                    this.interactionAddNewBtn.dataset.barcode = barcode;
                    this.openModal(this.interactionModal);
                },

                handleInteraction(e) {
                    const editBtn = e.target.closest('.edit-item-btn');
                    if (editBtn) {
                        this.editItem(parseInt(editBtn.dataset.id, 10));
                    }
                    const deleteBtn = e.target.closest('.delete-item-btn');
                    if (deleteBtn) {
                        this.deleteItem(parseInt(deleteBtn.dataset.id, 10));
                    }
                },

                deleteItem(id) {
                    this.inventory = this.inventory.filter(item => item.id !== id);
                    this.saveInventory();
                    this.render();
                    this.closeModal(this.interactionModal);
                },

                editItem(id) {
                    const item = this.inventory.find(i => i.id === id);
                    if (item) {
                        this.closeModal(this.interactionModal);
                        this.openItemForm(item);
                    }
                },

                addNewItemFromInteraction() {
                    const barcode = this.interactionAddNewBtn.dataset.barcode;
                    this.closeModal(this.interactionModal);
                    window.barcodeScannerApp.fetchAndOpenForm(barcode);
                },

                deleteSelectedItems() {
                    this.inventory = this.inventory.filter(item => !this.selectedItems.includes(item.id));
                    this.selectedItems = []; // Clear selections
                    this.saveInventory();
                    this.render();
                    this.closeModal(this.confirmModal);
                    this.updateDeleteButtonState();
                    this.selectAllCheckbox.checked = false; // Deselect 'Select All'
                }
            };

            const barcodeScannerApp = {
                inventoryApp: null,
                codeReader: null,
                isTorchOn: false,
                videoTrack: null, // New property to store the video track

                init(inventoryApp) {
                    this.inventoryApp = inventoryApp;
                    const hints = new Map();
                    const formats = [
                        ZXing.BarcodeFormat.EAN_13,
                        ZXing.BarcodeFormat.UPC_A,
                        ZXing.BarcodeFormat.EAN_8,
                        ZXing.BarcodeFormat.UPC_E,
                        ZXing.BarcodeFormat.CODE_128,
                    ];
                    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
                    this.codeReader = new ZXing.BrowserMultiFormatReader(hints);
                },

                async startScan() {
                    const videoElement = document.getElementById('barcodeVideo');
                    const modal = document.getElementById('barcodeScanModal');
                    const statusEl = document.getElementById('barcodeStatus');

                    this.inventoryApp.openModal(modal);
                    statusEl.textContent = 'Requesting camera access...';

                    try {
                        this.codeReader.decodeFromVideoDevice(undefined, videoElement, (result, err) => {
                            if (result) {
                                statusEl.textContent = `Found barcode: ${result.getText()}`;
                                this.playScanSuccessSound(); // Play sound on successful scan
                                this.fetchData(result.getText());
                                this.stopScan();
                            }
                            if (err && !(err instanceof ZXing.NotFoundException)) {
                                console.error(err);
                                statusEl.textContent = `Error: ${err}`;
                            }
                        });
                        statusEl.textContent = 'Searching for barcode...';

                        // Listen for loadedmetadata to ensure stream is ready before checking capabilities
                        videoElement.addEventListener('loadedmetadata', () => {
                            console.log('loadedmetadata fired. videoElement.srcObject:', videoElement.srcObject);
                            if (videoElement.srcObject) {
                                const track = videoElement.srcObject.getVideoTracks()[0];
                                if (track) {
                                    this.videoTrack = track; // Store the track
                                    console.log('MediaStreamTrack found:', track);
                                    const capabilities = track.getCapabilities();
                                    console.log('Track capabilities:', capabilities);
                                    if (capabilities.torch) {
                                        this.inventoryApp.toggleFlashlightBtn.classList.remove('hidden');
                                        this.inventoryApp.toggleFlashlightBtn.classList.remove('bg-yellow-500');
                                        this.inventoryApp.toggleFlashlightBtn.classList.add('bg-gray-500');
                                        console.log('Flashlight button shown and set to gray.');
                                    } else {
                                        this.inventoryApp.toggleFlashlightBtn.classList.add('hidden');
                                        console.log('Flashlight not supported, button hidden.');
                                    }
                                } else {
                                    this.inventoryApp.toggleFlashlightBtn.classList.add('hidden');
                                    console.log('No video track found, flashlight button hidden.');
                                }
                            } else {
                                this.inventoryApp.toggleFlashlightBtn.classList.add('hidden');
                                console.log('videoElement.srcObject is null, flashlight button hidden.');
                            }
                            // Clear the initial camera access denied message if camera is working
                            if (statusEl.textContent === 'Requesting camera access...' || statusEl.textContent.includes('Camera access denied')) {
                                statusEl.textContent = 'Searching for barcode...';
                            }
                        }, { once: true }); // Use { once: true } to remove the listener after it fires

                    } catch (err) {
                        console.error('Camera Error:', err);
                        statusEl.textContent = 'Camera access denied or not available.';
                        this.inventoryApp.toggleFlashlightBtn.classList.add('hidden');
                    }
                },

                stopScan() {
                    this.codeReader.reset();
                    this.inventoryApp.closeModal(document.getElementById('barcodeScanModal'));
                    // Turn off flashlight and hide button when scan stops
                    if (this.isTorchOn && this.videoTrack) {
                        this.videoTrack.applyConstraints({ advanced: [{ torch: false }] });
                        this.isTorchOn = false;
                    }
                    this.inventoryApp.toggleFlashlightBtn.classList.add('hidden');
                    this.videoTrack = null; // Clear the stored track
                },

                async toggleFlashlight() {
                    console.log('toggleFlashlight called. Current isTorchOn:', this.isTorchOn);
                    if (!this.videoTrack) {
                        console.warn('No video track available for flashlight control.');
                        return;
                    }
                    this.isTorchOn = !this.isTorchOn;
                    console.log('New isTorchOn:', this.isTorchOn);
                    try {
                        await this.videoTrack.applyConstraints({ advanced: [{ torch: this.isTorchOn }] });
                        console.log('applyConstraints successful. Torch state:', this.isTorchOn);
                        this.inventoryApp.toggleFlashlightBtn.classList.toggle('bg-yellow-500', this.isTorchOn);
                        this.inventoryApp.toggleFlashlightBtn.classList.toggle('bg-gray-500', !this.isTorchOn);
                        console.log('Flashlight button classes updated.');
                    } catch (error) {
                        console.error('Error setting torch:', error);
                        // Revert isTorchOn if setting torch failed
                        this.isTorchOn = !this.isTorchOn;
                    }
                },

                async fetchData(barcode) {
                    const statusEl = document.getElementById('barcodeStatus');
                    statusEl.textContent = `Checking inventory for ${barcode}...`;

                    const matchingItems = this.inventoryApp.inventory.filter(item => item.barcode === barcode);

                    if (matchingItems.length > 0) {
                        this.inventoryApp.openInteractionModal(matchingItems, barcode);
                        this.stopScan();
                    } else {
                        this.fetchAndOpenForm(barcode);
                    }
                },

                playScanSuccessSound() {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.type = 'sine'; // or 'square', 'sawtooth', 'triangle'
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // pitch in Hz
                        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                        gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01); // fade in
                        gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.15); // fade out

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.15); // duration
                    } catch (e) {
                        console.warn('Web Audio API not supported or failed to play sound:', e);
                    }
                },

                async fetchAndOpenForm(barcode) {
                    const statusEl = document.getElementById('barcodeStatus');
                    statusEl.textContent = `Fetching data for ${barcode}...`;
                    const apiUrl = `https://world.openfoodfacts.net/api/v2/product/${barcode}?fields=product_name,quantity,image_front_url`;

                    try {
                        const response = await fetch(apiUrl);
                        const data = await response.json();
                        console.log('Open Food Facts API Response:', data);

                        if (data.status === 1 && data.product && data.product.product_name) {
                            const rawQuantity = data.product.quantity || '';
                            let parsedQuantity = { quantity: 1, unit: 'units' }; // Default values

                            const match = rawQuantity.match(/(\d+)\s*([a-zA-Z]+)/);
                            if (match) {
                                parsedQuantity.quantity = parseInt(match[1], 10);
                                parsedQuantity.unit = match[2];
                            } else {
                                // Fallback for cases like '3 x 100g' or just '3'
                                const numMatch = rawQuantity.match(/(\d+)/);
                                if (numMatch) {
                                    parsedQuantity.quantity = parseInt(numMatch[1], 10);
                                } else if (rawQuantity.length > 0) {
                                    // If no number, but there's text, assume it's a unitless count of 1
                                    parsedQuantity.quantity = 1;
                                    parsedQuantity.unit = rawQuantity; // Use the whole string as unit if no number
                                }
                            }

                            this.inventoryApp.openItemForm();
                            document.getElementById('itemBarcode').value = barcode;
                            document.getElementById('itemName').value = data.product.product_name || '';
                            document.getElementById('itemQuantityNumeric').value = parsedQuantity.quantity;
                            document.getElementById('itemUnit').value = parsedQuantity.unit;
                            console.log('Product Image URL:', data.product.image_front_url);

                            // Default perishable date to 7 days from now
                            const date = new Date();
                            date.setDate(date.getDate() + 7);
                            document.getElementById('perishableDateInput').valueAsDate = date;

                        } else {
                            alert(`Product not found for barcode: ${barcode}`);
                        }
                    } catch (err) {
                        console.error('API Error:', err);
                        alert('Failed to fetch product data.');
                    }
                    this.stopScan(); // Stop scan after processing
                }
            };

            window.barcodeScannerApp = barcodeScannerApp;
            inventoryApp.init();
        });
    </script>
</body>
</html>